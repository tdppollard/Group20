---
title: "GDP School Hours Comparison"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Questions of interest:

Firstly, is the number of years children spend in school associated with a country's wealth and if so to what extent?  How does this relationship vary according to gender and generation of worker?  Secondly, what social factors are associated with a nation's wealth, particularly with regard to the involvement of women in the workforce?

``` {r packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(GGally)
library(skimr)
library(moderndive)
library(olsrr)
```

This section is the data wrangling that I did with the raw data as each column was contained in a different file.

I haven't uploaded all the raw files to GitHub, just the final version, so running this code won't work, but let me know if you'd like to see all the raw files.

``` {r wrangling1}

#  Pull each file and select the data for the year 2015
GDP <- data.frame(country = alternative_gdp_per_capita_ppp_wb$country,
                   gdp = alternative_gdp_per_capita_ppp_wb$"2015")
men15_24 <- mean_years_in_school_men_15_to_24_years %>%
  select("country", "2015")
men25_34 <- mean_years_in_school_men_25_to_34_years %>%
  select("country", "2015")
men35_44 <- mean_years_in_school_men_35_to_44_years %>%
  select("country", "2015")
men45_54 <- mean_years_in_school_men_45_to_54_years %>%
  select("country", "2015")
men55_64 <- mean_years_in_school_men_55_to_64_years %>%
  select("country", "2015")
men65_plus <- mean_years_in_school_men_65_plus_years %>%
  select("country", "2015")
women15_24 <- mean_years_in_school_women_15_to_24_years %>%
  select("country", "2015")
women25_34 <- mean_years_in_school_women_25_to_34_years %>%
  select("country", "2015")
women35_44 <- mean_years_in_school_women_35_to_44_years %>%
  select("country", "2015")
women45_54 <- mean_years_in_school_women_45_to_54_years %>%
  select("country", "2015")
women55_64 <- mean_years_in_school_women_55_to_64_years %>%
  select("country", "2015")
women65_plus <- mean_years_in_school_women_65_plus_years %>%
  select("country", "2015")

# Combine all the files and convert the GDP figure into a consistent numerical format

data <- GDP %>%
  mutate(k = str_detect(gdp, "k")) %>%
  mutate(gdp = as.numeric(str_remove(gdp, "k"))) %>%
  mutate(gdp = ifelse(k, gdp, gdp/1000)) %>%
  select(-k) %>%
  inner_join(women15_24, by = "country") %>%
  rename(women15_24 = "2015") %>%
  inner_join(women25_34, by = "country") %>%
  rename(women25_34 = "2015") %>%
  inner_join(women35_44, by = "country") %>%
  rename(women35_44 = "2015") %>%
  inner_join(women45_54, by = "country") %>%
  rename(women45_54 = "2015") %>%
  inner_join(women55_64, by = "country") %>%
  rename(women55_64 = "2015") %>%
  inner_join(women65_plus, by = "country") %>%
  rename(women65_plus = "2015") %>%
  inner_join(men15_24, by = "country") %>%
  rename(men15_24 = "2015") %>%
  inner_join(men25_34, by = "country") %>%
  rename(men25_34 = "2015") %>%
  inner_join(men35_44, by = "country") %>%
  rename(men35_44 = "2015") %>%
  inner_join(men45_54, by = "country") %>%
  rename(men45_54 = "2015") %>%
  inner_join(men55_64, by = "country") %>%
  rename(men55_64 = "2015") %>%
  inner_join(men65_plus, by = "country") %>%
  rename(men65_plus = "2015")

# Write data to csv file

write.csv(data, "GDP_school_years_2015.csv", row.names = FALSE)

```

``` {r wrangling2}

#  Pull each file and select the data for the year 1990
GDP <- data.frame(country = alternative_gdp_per_capita_ppp_wb$country,
                   gdp = alternative_gdp_per_capita_ppp_wb$"1990")
men15_24 <- mean_years_in_school_men_15_to_24_years %>%
  select("country", "1990")
men25_34 <- mean_years_in_school_men_25_to_34_years %>%
  select("country", "1990")
men35_44 <- mean_years_in_school_men_35_to_44_years %>%
  select("country", "1990")
men45_54 <- mean_years_in_school_men_45_to_54_years %>%
  select("country", "1990")
men55_64 <- mean_years_in_school_men_55_to_64_years %>%
  select("country", "1990")
men65_plus <- mean_years_in_school_men_65_plus_years %>%
  select("country", "1990")
women15_24 <- mean_years_in_school_women_15_to_24_years %>%
  select("country", "1990")
women25_34 <- mean_years_in_school_women_25_to_34_years %>%
  select("country", "1990")
women35_44 <- mean_years_in_school_women_35_to_44_years %>%
  select("country", "1990")
women45_54 <- mean_years_in_school_women_45_to_54_years %>%
  select("country", "1990")
women55_64 <- mean_years_in_school_women_55_to_64_years %>%
  select("country", "1990")
women65_plus <- mean_years_in_school_women_65_plus_years %>%
  select("country", "1990")

# Combine all the files and convert the GDP figure into a consistent numerical format

data <- GDP %>%
  mutate(k = str_detect(gdp, "k")) %>%
  mutate(gdp = as.numeric(str_remove(gdp, "k"))) %>%
  mutate(gdp = ifelse(k, gdp, gdp/1000)) %>%
  select(-k) %>%
  inner_join(women15_24, by = "country") %>%
  rename(women15_24 = "1990") %>%
  inner_join(women25_34, by = "country") %>%
  rename(women25_34 = "1990") %>%
  inner_join(women35_44, by = "country") %>%
  rename(women35_44 = "1990") %>%
  inner_join(women45_54, by = "country") %>%
  rename(women45_54 = "1990") %>%
  inner_join(women55_64, by = "country") %>%
  rename(women55_64 = "1990") %>%
  inner_join(women65_plus, by = "country") %>%
  rename(women65_plus = "1990") %>%
  inner_join(men15_24, by = "country") %>%
  rename(men15_24 = "1990") %>%
  inner_join(men25_34, by = "country") %>%
  rename(men25_34 = "1990") %>%
  inner_join(men35_44, by = "country") %>%
  rename(men35_44 = "1990") %>%
  inner_join(men45_54, by = "country") %>%
  rename(men45_54 = "1990") %>%
  inner_join(men55_64, by = "country") %>%
  rename(men55_64 = "1990") %>%
  inner_join(men65_plus, by = "country") %>%
  rename(men65_plus = "1990")

# Write data to csv file

write.csv(data, "GDP_school_years_1990.csv", row.names = FALSE)

```

```{r importData}
school2015 <- read.csv("GDP_school_years_2015.csv")
school1990 <- read.csv("GDP_school_years_1990.csv")
```

``` {r exploration, message = FALSE, warning = FALSE}

ggpairs(school2015[,-1])
ggpairs(school1990[,-1])

# The GDP data is very right skewed, so applying a log transformation

school2015 <- school2015 %>%
  mutate(logGDP = log(gdp))
school1990 <- school1990 %>%
  mutate(logGDP = log(gdp))
ggpairs(school2015[,-c(1:2)])
skim(school2015)
ggpairs(school1990[,-c(1:2)])
skim(school1990)

# Calculate correlations with logGDP

cor2015 <- data.frame(cor(school2015[,3:14],school2015$logGDP))
names(cor2015) <- "Correlation"
school1990 <- na.omit(school1990)
cor1990 <- data.frame(cor(school1990[,3:14],school1990$logGDP))
names(cor1990) <- "Correlation"

```

Bar chart showing correlations from 1990 data set of each age group with log GDP and scatterplot of highest correlating group

``` {r plot1990}
school1990 %>%
  na.omit() %>%
  ggplot(aes(women25_34, logGDP)) + geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Years in school - women aged 25-34")
cor1990 %>%
  rownames_to_column("Group") %>%
  ggplot(aes(Group, Correlation)) + geom_col() + theme(axis.text.x = element_text(angle = -45)) +
  labs(y = "Correlation with log GDP")
```

And repeated for 2015

``` {r plot2015}
school2015 %>%
  na.omit() %>%
  ggplot(aes(women25_34, logGDP)) + geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Years in school - women aged 25-34")
cor2015 %>%
  rownames_to_column("Group") %>%
  ggplot(aes(Group, Correlation)) + geom_col() + theme(axis.text.x = element_text(angle = -45)) +
  labs(y = "Correlation with log GDP")
```

Linear model fitted for highest correlating group 

``` {r lm}
mod2015f <- lm(logGDP ~ women25_34, data = school2015)
summary(mod2015f)
get_regression_table(mod2015f)
get_regression_summaries(mod2015f)

mod1990f <- lm(logGDP ~ women25_34, data = school1990)
summary(mod1990f)
get_regression_table(mod1990f)
get_regression_summaries(mod1990f)

```

Check model assumptions

``` {r assumptions}
get_regression_points(mod2015f) %>%
  ggplot(aes(logGDP_hat, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod2015f) %>%
  ggplot(aes(women25_34, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod2015f) %>%
  ggplot(aes(sample = residual)) + stat_qq()
```

Recreate the models but for men

``` {r lm1}
mod2015m <- lm(logGDP ~ men25_34, data = school2015)
summary(mod2015m)
get_regression_table(mod2015m)
get_regression_summaries(mod2015m)
exp(get_regression_table(mod2015m)$estimate[2])

mod1990m <- lm(logGDP ~ men25_34, data = school1990)
summary(mod1990m)
get_regression_table(mod1990m)
get_regression_summaries(mod1990m)
exp(get_regression_table(mod1990m)$estimate[2])
```

Check model assumptions

``` {r assumptions}
get_regression_points(mod2015m) %>%
  ggplot(aes(logGDP_hat, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod2015m) %>%
  ggplot(aes(men25_34, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod2015m) %>%
  ggplot(aes(sample = residual)) + stat_qq()
```

Prepare data on child mortality, fertility rate, murders, suicides and female participation in the workforce for 1990 and 2015.  More data wrangling. Skip to the next code chunk to run without the orginal files.

``` {r otherData}
# import child mortality data

child_mort <- child_mortality_0_5_year_olds_dying_per_1000_born %>%
  select("country", "1990", "2015") %>%
  rename(child_mort_1990 = "1990", child_mort_2015 = "2015")

# import fertility data

fert <- children_per_woman_total_fertility %>%
  select("country","1990", "2015") %>%
  rename(fert_1990 = "1990", fert_2015 ="2015")

# import data on female participation in the workforce

fem_part <- females_aged_15plus_labour_force_participation_rate_percent %>%
  select("country", "1990", "2015") %>%
  rename(fem_part_1990 = "1990", fem_part_2015 = "2015")

# import data on murders

murders <- murder_per_100000_people %>%
  select("country", "1990", "2015") %>%
  rename(murders_1990 = "1990", murders_2015 = "2015")

# import data on suicides

suicides <- suicide_per_100000_people %>%
  select("country", "1990", "2015") %>%
  rename(suicides_1990 = "1990", suicides_2015 = "2015")

# take most highly correlated column from the school years 2015 data set

school_fem_2015 <- school2015 %>%
  select("country", "gdp" ,"women25_34") %>%
  rename(gdp_2015 = gdp, sch_yrs_2015 = women25_34)

# combine into one file with the same column from the school years 1990 data set

gdp <- school1990 %>%
  select("country", "gdp", "women25_34") %>%
  rename(gdp_1990 = gdp, sch_yrs_1990 = women25_34) %>%
  right_join(school_fem_2015, by = "country") %>%
  mutate(log_gdp_1990 = log(gdp_1990), log_gdp_2015 = log(gdp_2015)) %>%
  left_join(child_mort, by ="country") %>%
  left_join(fert, by = "country") %>%
  left_join(fem_part, by = "country") %>%
  left_join(murders, by = "country") %>%
  left_join(suicides, by = "country") %>%
  select(country, gdp_1990, gdp_2015, log_gdp_1990, log_gdp_2015, everything())

# save to data file

write.csv(gdp, "GDP_1990_2015.csv", row.names = FALSE)

```

``` {r importGDPfemData}
gdp <- read.csv("GDP_1990_2015.csv")
```

Explore new data sets

``` {r exploration, message = FALSE, warning = FALSE}

gdp %>%
  skim()
# just look at countries without missing values
gdp %>%
  na.omit() %>%
  skim()
  
gdp %>%
  select(-country, -gdp_1990, -gdp_2015) %>%
  ggpairs()

```

Fit new linear models

``` {r lm2}

mod_1990_2 <- lm(log_gdp_1990 ~ sch_yrs_1990 + child_mort_1990 + fert_1990 + fem_part_1990 + murders_1990 + suicides_1990, data = gdp)
summary(mod_1990_2)

mod_2015_2 <- lm(log_gdp_2015 ~ sch_yrs_2015 + child_mort_2015 + fert_2015 + fem_part_2015 + murders_2015 + suicides_2015, data = gdp)
summary(mod_2015_2)

# implement forward stepwise regression based on significance level

ols_step_forward_p(mod_1990_2)
ols_step_forward_p(mod_2015_2)

# rebuild models based on most significant indicators (excluding murders due to high number of missing values)

mod_1990_3 <- lm(log_gdp_1990 ~ child_mort_1990 + sch_yrs_1990 + fem_part_1990, data = gdp)
summary(mod_1990_3)

mod_2015_3 <- lm(log_gdp_2015 ~ child_mort_2015 + sch_yrs_2015 + fert_2015, data = gdp)
summary(mod_2015_3)

# try swapping fem_part and fert

mod_1990_4 <- lm(log_gdp_1990 ~ child_mort_1990 + sch_yrs_1990 + fert_1990, data = gdp)
summary(mod_1990_4)

mod_2015_4 <- lm(log_gdp_2015 ~ child_mort_2015 + sch_yrs_2015 + fem_part_2015, data = gdp)
summary(mod_2015_4)

```

Noticeable that fertility rates have taken the place of female participation in the workforce between 1990 and 2015. Also noticeable that femal participation in the workplace is negatively correlated. 

Check model assumptions for model 3: 2015

``` {r assumptions2015}
get_regression_points(mod_2015_3) %>%
  ggplot(aes(log_gdp_2015_hat, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_2015_3) %>%
  ggplot(aes(sch_yrs_2015, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_2015_3) %>%
  ggplot(aes(child_mort_2015, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_2015_3) %>%
  ggplot(aes(fert_2015, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_2015_3) %>%
  ggplot(aes(sample = residual)) + stat_qq()
```

Check model assumptions for model 3: 1990

``` {r assumptions1990}
get_regression_points(mod_1990_3) %>%
  ggplot(aes(log_gdp_1990_hat, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_1990_3) %>%
  ggplot(aes(sch_yrs_1990, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_1990_3) %>%
  ggplot(aes(child_mort_1990, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_1990_3) %>%
  ggplot(aes(fem_part_1990, residual)) + geom_point() + geom_hline(yintercept = 0)
get_regression_points(mod_1990_3) %>%
  ggplot(aes(sample = residual)) + stat_qq()
```

print coefficient summaries

``` {r coefficients}

get_regression_table(mod_1990_3)
get_regression_table(mod_2015_3)


```
